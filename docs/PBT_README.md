# Population-Based Training (PBT) for Control Law Discovery

## æ¦‚è¿°

16-agentå¹¶è¡Œè®­ç»ƒç³»ç»Ÿï¼Œè‡ªåŠ¨ä¼˜åŒ–MCTSè¶…å‚æ•°ã€‚åŸºäºDeepMindçš„PBTæ¡†æ¶ï¼ˆJaderberg et al., 2018ï¼‰ã€‚

## æ ¸å¿ƒç‰¹æ€§

### ğŸ¯ è‡ªåŠ¨è¶…å‚æ•°ä¼˜åŒ–
- **MCTSå‚æ•°**: `puct_c`, `exploration_weight`, `dirichlet_eps/alpha`, `temperature`
- **è®­ç»ƒè¶…å‚**: å­¦ä¹ ç‡åŠ¨æ€è°ƒæ•´
- **ç­–ç•¥**: Exploitï¼ˆå¤åˆ¶å¼ºagentï¼‰+ Exploreï¼ˆå‚æ•°æ‰°åŠ¨ï¼‰

### ğŸš€ é«˜æ•ˆå¹¶è¡Œ
- **16ä¸ªagent**å¹¶è¡Œè®­ç»ƒ
- **å…±äº«Isaac Gym**ï¼š512ç¯å¢ƒæ± 
- **æ˜¾å­˜ä¼˜åŒ–**ï¼šå¯é€‰å…±äº«GNNç¼–ç å™¨ï¼ˆèŠ‚çœ60%æ˜¾å­˜ï¼‰

### ğŸ“Š æ€§èƒ½è¿½è¸ª
- æ¯ä¸ªagentç‹¬ç«‹æ€§èƒ½æ›²çº¿
- å…¨å±€æœ€ä½³ç¨‹åºè‡ªåŠ¨ä¿å­˜
- å‘¨æœŸæ€§checkpoint

## å¿«é€Ÿå¼€å§‹

### 1. åŸºç¡€è¿è¡Œï¼ˆæ¨èé…ç½®ï¼‰
```bash
./train_pbt.sh
```

### 2. è‡ªå®šä¹‰é…ç½®
```bash
python 01_pi_flight/train_pbt.py \
    --n-agents 16 \
    --pbt-interval 50 \
    --exploit-threshold 0.25 \
    --shared-encoder \
    --total-iters 5000 \
    --isaac-num-envs 512
```

### 3. å°è§„æ¨¡æµ‹è¯•ï¼ˆ8 agentsï¼‰
```bash
python 01_pi_flight/train_pbt.py \
    --n-agents 8 \
    --pbt-interval 30 \
    --total-iters 1000 \
    --isaac-num-envs 256
```

## å‚æ•°è¯´æ˜

### PBTæ ¸å¿ƒå‚æ•°

| å‚æ•° | é»˜è®¤å€¼ | è¯´æ˜ |
|------|--------|------|
| `--n-agents` | 16 | Agentæ•°é‡ |
| `--pbt-interval` | 50 | PBTè°ƒåº¦é—´éš”ï¼ˆè½®æ•°ï¼‰ |
| `--exploit-threshold` | 0.25 | æ·˜æ±°æ¯”ä¾‹ï¼ˆ25% = æ·˜æ±°4ä¸ªå¼±agentï¼‰|
| `--shared-encoder` | False | å…±äº«GNNç¼–ç å™¨ï¼ˆèŠ‚çœæ˜¾å­˜ï¼‰|

### è®­ç»ƒå‚æ•°

| å‚æ•° | é»˜è®¤å€¼ | è¯´æ˜ |
|------|--------|------|
| `--total-iters` | 5000 | æ€»è¿­ä»£æ•° |
| `--update-freq` | 50 | NNæ›´æ–°é¢‘ç‡ |
| `--batch-size` | 64 | æ‰¹é‡å¤§å° |
| `--replay-capacity` | 20000 | æ¯ä¸ªagentçš„bufferå¤§å° |

### MCTSå‚æ•°ï¼ˆè‡ªåŠ¨æ¼”åŒ–ï¼‰

PBTä¼šè‡ªåŠ¨è°ƒèŠ‚ä»¥ä¸‹å‚æ•°çš„èŒƒå›´ï¼š

| å‚æ•° | åˆå§‹èŒƒå›´ | æœ€ç»ˆèŒƒå›´ |
|------|----------|----------|
| `puct_c` | [1.0, 2.5] | [0.5, 3.0] |
| `exploration_weight` | [1.5, 4.0] | [1.0, 5.0] |
| `dirichlet_eps` | [0.15, 0.45] | [0.05, 0.6] |
| `temperature` | [0.6, 1.8] | [0.3, 2.5] |

## PBTå·¥ä½œæµç¨‹

```
åˆå§‹åŒ–ï¼š16ä¸ªagentï¼ŒéšæœºMCTSå‚æ•°
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ä¸»è®­ç»ƒå¾ªç¯ï¼ˆæ¯è½®ï¼‰                â”‚
â”‚                                   â”‚
â”‚  1. æ‰€æœ‰agentå¹¶è¡Œè®­ç»ƒ             â”‚
â”‚     - MCTSæœç´¢ï¼ˆå„è‡ªå‚æ•°ï¼‰        â”‚
â”‚     - ç”Ÿæˆç¨‹åº                    â”‚
â”‚     - Isaac Gymæ‰¹é‡è¯„ä¼°           â”‚
â”‚     - æ›´æ–°GNN                     â”‚
â”‚                                   â”‚
â”‚  2. æ›´æ–°å…¨å±€æœ€ä½³                  â”‚
â”‚                                   â”‚
â”‚  3. PBTè°ƒåº¦ï¼ˆæ¯50è½®ï¼‰             â”‚
â”‚     - æ’åºæ€§èƒ½ï¼ˆæœ€è¿‘10è½®å¹³å‡ï¼‰    â”‚
â”‚     - æ·˜æ±°ä¸‹ä½25%                 â”‚
â”‚     - å¤åˆ¶ä¸Šä½agentæƒé‡           â”‚
â”‚     - æ‰°åŠ¨MCTSå‚æ•°ï¼ˆÃ—0.8æˆ–Ã—1.2ï¼‰  â”‚
â”‚                                   â”‚
â”‚  4. ä¿å­˜checkpointï¼ˆæ¯200è½®ï¼‰     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â†“
æœ€ç»ˆè¾“å‡ºï¼šæœ€ä½³æ§åˆ¶å¾‹ç¨‹åº
```

## èµ„æºéœ€æ±‚

### ç¡¬ä»¶é…ç½®

#### æœ€ä½é…ç½®ï¼ˆ8 agentsï¼‰
- **GPU**: RTX 3060 (12GB)
- **RAM**: 16GB
- **CPU**: 8æ ¸

#### æ¨èé…ç½®ï¼ˆ16 agentsï¼‰
- **GPU**: RTX 3090 / 4090 (24GB)
- **RAM**: 32GB
- **CPU**: 16æ ¸

#### æ˜¾å­˜å ç”¨ä¼°ç®—

| æ¨¡å¼ | ç¼–ç å™¨ | Policyå¤´Ã—16 | ä¼˜åŒ–å™¨ | æ€»è®¡ |
|------|--------|-------------|--------|------|
| ç‹¬ç«‹æ¨¡å‹ | 8GB | - | 4GB | ~12GB |
| **å…±äº«ç¼–ç å™¨** | **0.5GB** | **0.8GB** | **1.5GB** | **~3GB** âœ… |

ğŸ’¡ **æ¨èä½¿ç”¨ `--shared-encoder` èŠ‚çœæ˜¾å­˜ï¼**

### è®­ç»ƒæ—¶é—´ä¼°ç®—

- **å•è½®è¿­ä»£**: ~30-60ç§’ï¼ˆå–å†³äºMCTSæ¨¡æ‹Ÿæ•°ï¼‰
- **1000è½®**: ~12-24å°æ—¶
- **5000è½®**: ~3-5å¤©

## è¾“å‡ºæ–‡ä»¶

```
results/
â”œâ”€â”€ pbt_best_program.json          # å…¨å±€æœ€ä½³ç¨‹åº
â”œâ”€â”€ pbt_iter200.pt                 # Checkpoint (200è½®)
â”œâ”€â”€ pbt_iter400.pt                 # Checkpoint (400è½®)
â”œâ”€â”€ ...
â””â”€â”€ pbt_final.json                 # æœ€ç»ˆç»“æœ
```

## ç›‘æ§å’Œå¯è§†åŒ–

### å®æ—¶ç›‘æ§
è®­ç»ƒè¿‡ç¨‹ä¸­ä¼šè¾“å‡ºï¼š
- æ¯è½®16ä¸ªagentçš„å¥–åŠ±
- æ€§èƒ½æ’å
- PBTè°ƒåº¦è®°å½•ï¼ˆå¤åˆ¶+æ‰°åŠ¨ï¼‰
- å…¨å±€æœ€ä½³æ›´æ–°

### ç¤ºä¾‹è¾“å‡º
```
============================================================
Iteration 50 / 5000
============================================================

Agentæ€§èƒ½æ’å:
  1. Agent 7: -2.341 ğŸ†
  2. Agent 3: -2.568 ğŸ†
  3. Agent 11: -2.789 ğŸ†
  ...
  14. Agent 5: -4.123
  15. Agent 9: -4.567
  16. Agent 2: -5.012

æ·˜æ±°ä¸‹ä½4ä¸ªagentï¼Œå¤åˆ¶ä¸Šä½agent:
  ğŸ”„ Agent 2 (â­-5.01) å¤åˆ¶ Agent 7 (â­-2.34)
  ğŸ”„ Agent 9 (â­-4.57) å¤åˆ¶ Agent 3 (â­-2.57)
  ...

ç»Ÿè®¡:
  å¹³å‡å¥–åŠ±: -3.456
  æœ€å¤§å¥–åŠ±: -2.341
  å…¨å±€æœ€ä½³: -2.123 (Agent 7)
  ç”¨æ—¶: 45.23s
```

## ä¸å•agentè®­ç»ƒå¯¹æ¯”

| æŒ‡æ ‡ | å•Agent | 16-Agent PBT | ä¼˜åŠ¿ |
|------|---------|--------------|------|
| å‚æ•°è°ƒä¼˜ | æ‰‹å·¥ç½‘æ ¼æœç´¢ | è‡ªåŠ¨æ¼”åŒ– | âœ… è‡ªåŠ¨åŒ– |
| æ¢ç´¢æ•ˆç‡ | å•ä¸€ç­–ç•¥ | 16ç§ç­–ç•¥å¹¶è¡Œ | âœ… 3-5Ã— åŠ é€Ÿ |
| é²æ£’æ€§ | ä¾èµ–åˆå§‹å‚æ•° | ç¾¤ä½“å¤šæ ·æ€§ | âœ… æ›´ç¨³å®š |
| èµ„æºå ç”¨ | 1Ã— | ~1.5Ã— | âš ï¸ ç•¥é«˜ |

## æœ€ä½³å®è·µ

### 1. åˆæœŸæ¢ç´¢ï¼ˆå‰500è½®ï¼‰
- æ›´é«˜çš„`exploit_threshold`ï¼ˆ0.3-0.4ï¼‰
- æ›´é¢‘ç¹çš„PBTè°ƒåº¦ï¼ˆæ¯30è½®ï¼‰
- æ›´å¤§çš„å‚æ•°æ‰°åŠ¨èŒƒå›´

### 2. åæœŸåˆ©ç”¨ï¼ˆ500è½®åï¼‰
- é™ä½`exploit_threshold`ï¼ˆ0.2ï¼‰
- å»¶é•¿PBTé—´éš”ï¼ˆæ¯100è½®ï¼‰
- ç¼©å°æ‰°åŠ¨èŒƒå›´ï¼ˆ0.9, 1.1ï¼‰

### 3. æ˜¾å­˜ä¸è¶³æ—¶
```bash
# ä½¿ç”¨å…±äº«ç¼–ç å™¨ + é™ä½batch size
python train_pbt.py \
    --shared-encoder \
    --batch-size 32 \
    --n-agents 8
```

### 4. è°ƒè¯•æ¨¡å¼
```bash
# å°‘æ•°agent + çŸ­æ—¶ä»¿çœŸ
python train_pbt.py \
    --n-agents 4 \
    --duration 5 \
    --total-iters 100 \
    --pbt-interval 20
```

## å®éªŒå»ºè®®

### Baselineå¯¹æ¯”
å»ºè®®åŒæ—¶è¿è¡Œå•agentè®­ç»ƒä½œä¸ºå¯¹æ¯”ï¼š
```bash
# ç»ˆç«¯1: PBT
./train_pbt.sh

# ç»ˆç«¯2: å•agent baseline
./train_quick_test.sh
```

### Ablation Study
1. **Agentæ•°é‡**: 4, 8, 16, 32
2. **PBTé—´éš”**: 20, 50, 100
3. **æ·˜æ±°ç‡**: 0.1, 0.25, 0.5
4. **å‚æ•°æ‰°åŠ¨**: (0.9, 1.1), (0.8, 1.2), (0.7, 1.3)

## æ•…éšœæ’æŸ¥

### é—®é¢˜1: æ˜¾å­˜ä¸è¶³
```
RuntimeError: CUDA out of memory
```
**è§£å†³**:
- æ·»åŠ  `--shared-encoder`
- é™ä½ `--batch-size` (64 â†’ 32)
- å‡å°‘ `--n-agents` (16 â†’ 8)

### é—®é¢˜2: Isaac Gymå´©æºƒ
```
Segmentation fault (core dumped)
```
**è§£å†³**:
- é™ä½ `--isaac-num-envs` (512 â†’ 256)
- æ£€æŸ¥Isaac Gymå®‰è£…

### é—®é¢˜3: æ‰€æœ‰agentæ€§èƒ½ç›¸ä¼¼
**åŸå› **: å‚æ•°æ‰°åŠ¨ä¸è¶³
**è§£å†³**:
- å¢å¤§æ‰°åŠ¨èŒƒå›´: `(0.7, 1.3)`
- ç¼©çŸ­PBTé—´éš”: `--pbt-interval 30`

## å¼•ç”¨

å¦‚æœæ‚¨ä½¿ç”¨æ­¤ä»£ç ï¼Œè¯·å¼•ç”¨ï¼š

```bibtex
@misc{pi-flight-pbt,
  title={Population-Based Training for MCTS-based Control Law Discovery},
  author={Your Name},
  year={2025},
  note={Based on PBT (Jaderberg et al., 2018) and AlphaZero (Silver et al., 2017)}
}
```

## ç›¸å…³è®ºæ–‡

1. **PBT**: Jaderberg et al. (2018) "Population Based Training of Neural Networks" (ICLR)
2. **AlphaZero**: Silver et al. (2017) "Mastering Chess and Shogi by Self-Play" (Nature)
3. **AlphaStar**: Vinyals et al. (2019) "Grandmaster level in StarCraft II" (Nature)

## TODO

- [ ] å®ç°å®Œæ•´çš„agentè®­ç»ƒå¾ªç¯ï¼ˆå½“å‰ä¸ºæ¡†æ¶ï¼‰
- [ ] æ·»åŠ TensorBoardå¯è§†åŒ–
- [ ] æ”¯æŒåˆ†å¸ƒå¼è®­ç»ƒï¼ˆå¤šGPUï¼‰
- [ ] æ·»åŠ meta-policyç½‘ç»œï¼ˆå­¦ä¹ ä½•æ—¶å¤åˆ¶/æ‰°åŠ¨ï¼‰
- [ ] å®ç°adaptive PBTï¼ˆåŠ¨æ€è°ƒæ•´æ·˜æ±°ç‡ï¼‰
